server {
        listen 80;
        server_name localhost;

        root /opt/vue-fastapi-admin/web/dist;
        index index.html index.htm;

        # 关键：避免 SPA 的 index.html 被浏览器/代理/Cloudflare 缓存导致“重启后仍是旧页面”。
        location = /index.html {
                add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
                add_header Pragma "no-cache" always;
                add_header Expires "0" always;
                try_files $uri =404;
        }

        # 资源文件（hash 文件名）可长缓存
        location ^~ /assets/ {
                add_header Cache-Control "public, max-age=31536000, immutable" always;
                try_files $uri =404;
        }

        location ^~ /resource/ {
                add_header Cache-Control "public, max-age=31536000, immutable" always;
                try_files $uri =404;
        }

        location / {
              add_header Cache-Control "no-store" always;
              try_files $uri $uri/ /index.html;
        }

        # WebSocket（Dashboard 实时推送）
        location ^~ /api/v1/ws/ {
                proxy_pass http://127.0.0.1:9999;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
        }

        # SSE（消息流）
        location ^~ /api/v1/messages/ {
                proxy_pass http://127.0.0.1:9999;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_buffering off;
                proxy_cache off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
        }

        location ^~ /api/ {
                proxy_pass http://127.0.0.1:9999;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
        }

}
