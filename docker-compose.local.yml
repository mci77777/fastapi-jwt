services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # 前端构建期注入（静态产物）
        VITE_BASE_API: ${VITE_BASE_API:-/api/v1}
        VITE_API_URL: ${VITE_API_URL:-}
        VITE_AUTH_MODE: ${VITE_AUTH_MODE:-auto}
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
    image: vue-fastapi-admin:local
    container_name: vue-fastapi-admin-local
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3101}:80"
      - "${API_PORT:-9999}:9999"
    environment:
      # SQLite（bind mount 目录，避免 WAL/-shm 文件丢失导致状态不落盘）
      - SQLITE_DB_PATH=db/db.sqlite3
      # 后端 JWT 校验（最小可用）
      - SUPABASE_JWKS_URL=${SUPABASE_JWKS_URL}
      - SUPABASE_ISSUER=${SUPABASE_ISSUER}
      # 可选：本地 admin/123456 登录（/api/v1/base/access_token）生成测试 JWT
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-authenticated}

      # 常用开关
      - ANON_ENABLED=true
      - RATE_LIMIT_ENABLED=true
      - POLICY_GATE_ENABLED=true

      # 可选：日志落盘
      - LOG_TO_FILE=${LOG_TO_FILE:-false}
      - LOG_FILE_PATH=${LOG_FILE_PATH:-logs/app.log}

      # Agent Tools：Web 搜索（Exa，可选；也可在 Dashboard 中写入 DB 配置）
      - EXA_API_KEY=${EXA_API_KEY}
    volumes:
      - ./logs:/opt/vue-fastapi-admin/logs
      - ./db:/opt/vue-fastapi-admin/db
