# Token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶ - äº¤æ¥æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0  
> **æ—¥æœŸ**: 2025-10-14  
> **çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆå¾…æµ‹è¯•ï¼‰

---

## ğŸ“‹ ä»»åŠ¡æ€»ç»“

### é—®é¢˜
- **ç°è±¡**: Admin ç™»å½•åæŒç»­å‡ºç° JWT éªŒè¯å¤±è´¥ï¼ˆ401 é”™è¯¯ï¼‰
- **æ ¹æœ¬åŸå› **: Token æœ‰æ•ˆæœŸåªæœ‰ 1 å°æ—¶ï¼Œç”¨æˆ·ç™»å½•åè¶…è¿‡ 1 å°æ—¶ä¼šè‡ªåŠ¨è¿‡æœŸ

### è§£å†³æ–¹æ¡ˆ
1. **å»¶é•¿ Token æœ‰æ•ˆæœŸ**ï¼šä» 1 å°æ—¶å»¶é•¿åˆ° 24 å°æ—¶ âœ…
2. **å®ç°è‡ªåŠ¨åˆ·æ–°æœºåˆ¶**ï¼šToken å³å°†è¿‡æœŸæ—¶ï¼ˆå‰©ä½™ 5 åˆ†é’Ÿï¼‰è‡ªåŠ¨åˆ·æ–° âœ…

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### åç«¯ä¿®æ”¹ï¼ˆ2 å¤„ï¼‰

#### 1. å»¶é•¿ Token æœ‰æ•ˆæœŸ
**æ–‡ä»¶**: `app/api/v1/base.py`  
**å‡½æ•°**: `create_test_jwt_token()`

**ä¿®æ”¹å‰**ï¼š
```python
"exp": now + 3600,  # 1å°æ—¶åè¿‡æœŸ
```

**ä¿®æ”¹å**ï¼š
```python
def create_test_jwt_token(username: str, expire_hours: int = 24) -> str:
    """åˆ›å»ºæµ‹è¯•JWT tokenã€‚

    Args:
        username: ç”¨æˆ·å
        expire_hours: Token æœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰ï¼Œé»˜è®¤ 24 å°æ—¶
    """
    # ...
    "exp": now + (expire_hours * 3600),  # é»˜è®¤ 24 å°æ—¶åè¿‡æœŸ
```

#### 2. æ–°å¢åˆ·æ–°ç«¯ç‚¹
**æ–‡ä»¶**: `app/api/v1/base.py`  
**ç«¯ç‚¹**: `POST /api/v1/base/refresh_token`

**åŠŸèƒ½**ï¼š
- éªŒè¯å½“å‰ Token æ˜¯å¦æœ‰æ•ˆ
- ç”Ÿæˆæ–°çš„ Tokenï¼ˆ24 å°æ—¶æœ‰æ•ˆæœŸï¼‰
- è¿”å›æ–° Token å’Œæœ‰æ•ˆæœŸä¿¡æ¯

**è¯·æ±‚**ï¼š
```bash
POST /api/v1/base/refresh_token
Authorization: Bearer <old_token>
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "msg": "Token åˆ·æ–°æˆåŠŸ",
  "data": {
    "access_token": "<new_token>",
    "token_type": "bearer",
    "expires_in": 86400
  }
}
```

---

### å‰ç«¯ä¿®æ”¹ï¼ˆ1 å¤„ï¼‰

**æ–‡ä»¶**: `web/src/utils/http/interceptors.js`

**æ–°å¢åŠŸèƒ½**ï¼š
1. **Token è¿‡æœŸæ£€æµ‹**ï¼š`shouldRefreshToken()` å‡½æ•°
   - è§£ç  JWT payload
   - æ£€æŸ¥å‰©ä½™æ—¶é—´
   - å‰©ä½™ < 5 åˆ†é’Ÿæ—¶è¿”å› true

2. **è‡ªåŠ¨åˆ·æ–°é€»è¾‘**ï¼š`refreshToken()` å‡½æ•°
   - è°ƒç”¨åç«¯ `/api/v1/base/refresh_token` ç«¯ç‚¹
   - ä¿å­˜æ–° Token åˆ° localStorage
   - å¹¶å‘æ§åˆ¶ï¼ˆé¿å…é‡å¤åˆ·æ–°ï¼‰
   - é”™è¯¯å¤„ç†ï¼ˆåˆ·æ–°å¤±è´¥æ—¶é‡å®šå‘ç™»å½•ï¼‰

3. **è¯·æ±‚æ‹¦æˆªå™¨å¢å¼º**ï¼š`reqResolve()` å‡½æ•°
   - æ£€æŸ¥ Token æ˜¯å¦å³å°†è¿‡æœŸ
   - è‡ªåŠ¨åˆ·æ–°åä½¿ç”¨æ–° Token
   - å¯¹ç”¨æˆ·é€æ˜ï¼ˆæ— æ„ŸçŸ¥ï¼‰

**å…³é”®ä»£ç **ï¼š
```javascript
export async function reqResolve(config) {
  if (config.noNeedToken) {
    return config
  }

  const token = getToken()
  if (token) {
    // æ£€æŸ¥ Token æ˜¯å¦å³å°†è¿‡æœŸ
    if (shouldRefreshToken(token)) {
      try {
        console.log('â° Token å³å°†è¿‡æœŸï¼Œè‡ªåŠ¨åˆ·æ–°...')
        const newToken = await refreshToken()
        config.headers.Authorization = `Bearer ${newToken}`
      } catch (error) {
        config.headers.Authorization = `Bearer ${token}`
      }
    } else {
      config.headers.Authorization = `Bearer ${token}`
    }
  }

  return config
}
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### åç«¯ï¼ˆ1 ä¸ªæ–‡ä»¶ï¼‰
- `app/api/v1/base.py`
  - ä¿®æ”¹ `create_test_jwt_token()` å‡½æ•°ï¼ˆ+7 è¡Œï¼‰
  - æ–°å¢ `refresh_token()` ç«¯ç‚¹ï¼ˆ+35 è¡Œï¼‰

### å‰ç«¯ï¼ˆ1 ä¸ªæ–‡ä»¶ï¼‰
- `web/src/utils/http/interceptors.js`
  - æ–°å¢ `shouldRefreshToken()` å‡½æ•°ï¼ˆ+30 è¡Œï¼‰
  - æ–°å¢ `refreshToken()` å‡½æ•°ï¼ˆ+60 è¡Œï¼‰
  - ä¿®æ”¹ `reqResolve()` å‡½æ•°ï¼ˆ+15 è¡Œï¼‰

### æµ‹è¯•è„šæœ¬ï¼ˆ2 ä¸ªæ–‡ä»¶ï¼‰
- `scripts/test_token_refresh.py` - å®Œæ•´æµ‹è¯•è„šæœ¬
- `scripts/test_token_simple.py` - ç®€åŒ–æµ‹è¯•è„šæœ¬

### æ–‡æ¡£ï¼ˆ2 ä¸ªæ–‡ä»¶ï¼‰
- `docs/TOKEN_REFRESH_IMPLEMENTATION.md` - è¯¦ç»†å®ç°æ–‡æ¡£
- `docs/TOKEN_REFRESH_HANDOVER.md` - æœ¬æ–‡æ¡£

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### å‰ææ¡ä»¶
ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼š
```bash
# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
curl http://localhost:9999/api/v1/healthz

# å¦‚æœæ²¡æœ‰è¿è¡Œï¼Œå¯åŠ¨åç«¯
python run.py
```

### æµ‹è¯• 1ï¼šè¿è¡Œæµ‹è¯•è„šæœ¬
```bash
# ç®€åŒ–ç‰ˆæµ‹è¯•ï¼ˆæ¨èï¼‰
python scripts/test_token_simple.py

# å®Œæ•´ç‰ˆæµ‹è¯•
python scripts/test_token_refresh.py
```

**é¢„æœŸè¾“å‡º**ï¼š
```
============================================================
  1. ç™»å½•è·å– Token
============================================================
[OK] ç™»å½•æˆåŠŸ
   Token é•¿åº¦: 200+
   æœ‰æ•ˆæœŸ: 24.0 å°æ—¶

============================================================
  2. åˆ·æ–° Token
============================================================
[OK] Token åˆ·æ–°æˆåŠŸ
   æ–° Token é•¿åº¦: 200+
   æœ‰æ•ˆæœŸ: 24.0 å°æ—¶

============================================================
  3. ä½¿ç”¨æ–° Token è®¿é—®å—ä¿æŠ¤ç«¯ç‚¹
============================================================
[OK] è®¿é—®æˆåŠŸ
   ç”¨æˆ·å: admin

============================================================
  [OK] æ‰€æœ‰æµ‹è¯•é€šè¿‡
============================================================
```

### æµ‹è¯• 2ï¼šæµè§ˆå™¨æµ‹è¯•

1. **å¯åŠ¨å‰ç«¯**ï¼š
   ```bash
   cd web && pnpm dev
   ```

2. **è®¿é—®ç™»å½•é¡µ**ï¼š
   ```
   http://localhost:3101/login
   ```

3. **ç™»å½•ç³»ç»Ÿ**ï¼š
   - ç”¨æˆ·åï¼š`admin`
   - å¯†ç ï¼š`123456`

4. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°**ï¼ˆF12ï¼‰

5. **æ£€æŸ¥ Token**ï¼š
   ```javascript
   // åœ¨æ§åˆ¶å°æ‰§è¡Œ
   const tokenItem = localStorage.getItem('ACCESS_TOKEN');
   const tokenData = JSON.parse(tokenItem);
   const token = tokenData.value;

   // è§£ç  Token
   const parts = token.split('.');
   const payload = JSON.parse(atob(parts[1]));

   console.log('è¿‡æœŸæ—¶é—´:', new Date(payload.exp * 1000));
   console.log('å‰©ä½™æ—¶é—´:', (payload.exp - Math.floor(Date.now() / 1000)) / 3600, 'å°æ—¶');
   ```

6. **æ¨¡æ‹Ÿå³å°†è¿‡æœŸ**ï¼ˆå¯é€‰ï¼‰ï¼š
   ```javascript
   // ä¿®æ”¹ Token è¿‡æœŸæ—¶é—´ä¸º 4 åˆ†é’Ÿå
   const now = Math.floor(Date.now() / 1000);
   payload.exp = now + 240; // 4 åˆ†é’Ÿåè¿‡æœŸ

   // é‡æ–°ç¼–ç ï¼ˆæ³¨æ„ï¼šè¿™åªæ˜¯æ¨¡æ‹Ÿï¼Œå®é™…ç­¾åä¼šå¤±æ•ˆï¼‰
   // çœŸå®æµ‹è¯•éœ€è¦ç­‰å¾… Token è‡ªç„¶è¿‡æœŸ
   ```

7. **è§‚å¯Ÿè‡ªåŠ¨åˆ·æ–°**ï¼š
   - ç­‰å¾… Token å‰©ä½™æ—¶é—´ < 5 åˆ†é’Ÿ
   - å‘é€ä»»æ„ API è¯·æ±‚ï¼ˆä¾‹å¦‚åˆ·æ–°é¡µé¢ï¼‰
   - æ§åˆ¶å°åº”æ˜¾ç¤ºï¼š`â° Token å³å°†è¿‡æœŸï¼Œè‡ªåŠ¨åˆ·æ–°...`
   - ç„¶åæ˜¾ç¤ºï¼š`âœ… Token åˆ·æ–°æˆåŠŸ`

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

- [ ] åç«¯æœåŠ¡å™¨æ­£å¸¸è¿è¡Œï¼ˆ`http://localhost:9999/api/v1/healthz` è¿”å› 200ï¼‰
- [ ] ç™»å½•æˆåŠŸå Token æœ‰æ•ˆæœŸä¸º 24 å°æ—¶
- [ ] åˆ·æ–°ç«¯ç‚¹ `/api/v1/base/refresh_token` å¯ä»¥æ­£å¸¸è°ƒç”¨
- [ ] å‰ç«¯è‡ªåŠ¨åˆ·æ–°é€»è¾‘æ­£å¸¸å·¥ä½œï¼ˆå‰©ä½™ 5 åˆ†é’Ÿæ—¶è§¦å‘ï¼‰
- [ ] åˆ·æ–°å¤±è´¥æ—¶æ­£ç¡®å¤„ç†ï¼ˆæ¸…é™¤ Token + é‡å®šå‘ç™»å½•ï¼‰
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ— é”™è¯¯
- [ ] ç”¨æˆ·å¯ä»¥é•¿æ—¶é—´ä½¿ç”¨ç³»ç»Ÿè€Œä¸éœ€è¦é‡æ–°ç™»å½•

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### æœ¬åœ°æµ‹è¯•
```bash
# 1. å¯åŠ¨åç«¯
python run.py

# 2. å¯åŠ¨å‰ç«¯
cd web && pnpm dev

# 3. è¿è¡Œæµ‹è¯•
python scripts/test_token_simple.py

# 4. æµè§ˆå™¨æµ‹è¯•
# è®¿é—® http://localhost:3101/login
# ç™»å½•åè§‚å¯Ÿæ§åˆ¶å°è¾“å‡º
```

### ç”Ÿäº§éƒ¨ç½²
```bash
# 1. æ„å»ºå‰ç«¯
cd web && pnpm build

# 2. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
# å‰ç«¯ï¼šhttps://web.gymbro.cloud
# åç«¯ï¼šhttps://api.gymbro.cloud

# 3. éªŒè¯
# è®¿é—® https://web.gymbro.cloud/login
# ç™»å½•åé•¿æ—¶é—´ä½¿ç”¨ï¼ŒéªŒè¯ä¸ä¼šè‡ªåŠ¨ç™»å‡º
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åç«¯æœåŠ¡å™¨å¿…é¡»è¿è¡Œ**ï¼š
   - æµ‹è¯•å‰ç¡®ä¿åç«¯æœåŠ¡å™¨åœ¨ `http://localhost:9999` è¿è¡Œ
   - ä½¿ç”¨ `curl http://localhost:9999/api/v1/healthz` éªŒè¯

2. **Token åˆ·æ–°é˜ˆå€¼**ï¼š
   - å½“å‰è®¾ç½®ä¸ºå‰©ä½™ 5 åˆ†é’Ÿæ—¶è§¦å‘åˆ·æ–°
   - å¯ä»¥åœ¨ `web/src/utils/http/interceptors.js` ä¸­ä¿®æ”¹é˜ˆå€¼

3. **å¹¶å‘æ§åˆ¶**ï¼š
   - ä½¿ç”¨ Promise é˜Ÿåˆ—é¿å…é‡å¤åˆ·æ–°
   - å¤šä¸ªå¹¶å‘è¯·æ±‚ä¼šå…±äº«åŒä¸€ä¸ªåˆ·æ–° Promise

4. **é”™è¯¯å¤„ç†**ï¼š
   - åˆ·æ–°å¤±è´¥æ—¶ä¼šè‡ªåŠ¨æ¸…é™¤ Token å¹¶é‡å®šå‘ç™»å½•
   - ä¸è¦åœ¨åˆ·æ–°å¤±è´¥åç»§ç»­ä½¿ç”¨æ—§ Token

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **è¯¦ç»†å®ç°æ–‡æ¡£**: `docs/TOKEN_REFRESH_IMPLEMENTATION.md`
- **JWT ç¡¬åŒ–æŒ‡å—**: `docs/JWT_HARDENING_GUIDE.md`
- **ç½‘å…³è®¤è¯æ–‡æ¡£**: `docs/GW_AUTH_README.md`
- **é¡¹ç›®æ¦‚è§ˆ**: `docs/PROJECT_OVERVIEW.md`

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæµ‹è¯•è„šæœ¬è¿æ¥å¤±è´¥
**é”™è¯¯ä¿¡æ¯**ï¼š`[WinError 10061] ç”±äºç›®æ ‡è®¡ç®—æœºç§¯ææ‹’ç»ï¼Œæ— æ³•è¿æ¥ã€‚`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¯åŠ¨åç«¯æœåŠ¡å™¨
python run.py

# æˆ–ä½¿ç”¨ä¸€é”®å¯åŠ¨è„šæœ¬
.\start-dev.ps1
```

### é—®é¢˜ 2ï¼šToken åˆ·æ–°å¤±è´¥
**é”™è¯¯ä¿¡æ¯**ï¼š`Token refresh failed: 401`

**å¯èƒ½åŸå› **ï¼š
1. æ—§ Token å·²è¿‡æœŸä¸”è¶…è¿‡å®½é™æœŸï¼ˆÂ±120 ç§’ï¼‰
2. åç«¯ JWT é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ JWT é…ç½®
JWT_CLOCK_SKEW_SECONDS=120
JWT_REQUIRE_NBF=false
JWT_ALLOWED_ALGORITHMS=ES256,RS256,HS256

# é‡å¯åç«¯æœåŠ¡å™¨
python run.py
```

### é—®é¢˜ 3ï¼šå‰ç«¯è‡ªåŠ¨åˆ·æ–°ä¸è§¦å‘
**å¯èƒ½åŸå› **ï¼š
1. Token å‰©ä½™æ—¶é—´ > 5 åˆ†é’Ÿ
2. æµè§ˆå™¨æ§åˆ¶å°æœ‰ JavaScript é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥ Token å‰©ä½™æ—¶é—´
const tokenItem = localStorage.getItem('ACCESS_TOKEN');
const tokenData = JSON.parse(tokenItem);
const token = tokenData.value;
const parts = token.split('.');
const payload = JSON.parse(atob(parts[1]));
const remaining = payload.exp - Math.floor(Date.now() / 1000);
console.log('å‰©ä½™æ—¶é—´:', remaining / 60, 'åˆ†é’Ÿ');
```

---

**å®Œæˆæ—¥æœŸ**: 2025-10-14  
**éªŒæ”¶çŠ¶æ€**: âœ… ä»£ç å®Œæˆï¼ˆå¾…æµ‹è¯•ï¼‰  
**ä¸‹ä¸€æ­¥**: å¯åŠ¨æœåŠ¡å™¨å¹¶è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½
