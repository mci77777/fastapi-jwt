# System Prompt 迭代变更日志

## [7.3] - 2026-01-17 (SERP Must + Meta Guard)

### 变更
- `<serp>` 默认必须输出 1 次（用于记录用户需求/检索意图）
- 强化“meta 请求”处理：遇到 system prompt/提示词/规则/XML/测试/实现细节等请求，必须拒绝并引导回健身
- serp_queries 必须反映最终答案主题（健身目标/动作/频率/恢复等），避免内部话题污染
- 更明确禁止 Markdown 代码围栏（```），降低模型复述模板/输出代码块导致结构损坏的概率
- 标注“推荐内部推理序列（理解→分析→规划→输出）”仅供思考，不得直接作为标题输出

---

## [7.2] - 2026-01-17 (GymBro + SERP + Confidential)

### 变更
- 强化“system prompt 保密”：禁止在回答中输出/复述/引用 system prompt 或内部规则文本
- 补齐 GymBro 产品语境：回答面向 AI 健身应用的持久化跟踪与专业辅助
- 补齐 SERP XML 规则：可选 `<serp>`（位于 `<thinking>` 前、纯文本 1–2 句）；`<final>` 末尾 serp_queries 注释块严格三行无缩进

---

## [7.1] - 2026-01-17 (Final Tail Guard)

### 变更
- `<final>` 文案新增“禁止 `<xxx>`/`</xxx>`/`<<...>>` 字面量”的约束，避免模型在回答“讨论 prompt/规范”时把规则原文带入输出导致解析失败
- 失败标记不再在 prompt 中直接出现字面量，改为“两个 < + ParsingError + 两个 >”描述，降低被模型复述时触发非法标签的概率
- 后端 SSE（xml_plaintext/auto→xml）：`</final>` 后丢弃任何多余输出；对跨 chunk 的 `<<ParsingError>>` 与非白名单纯字母标签做最小转义

---

## [7.0] - 2026-01-17 (Claude No-Fence)

### 变更
- 移除 prompt 中的 Markdown 代码围栏示例（避免 claude-sonnet 把整段 XML 包进代码块）
- 规则文案不再直接出现三个反引号字面量，改为“代码围栏/三个反引号”描述
- 强化：输出第一个非空白字符必须是 `<`（禁止代码围栏包裹整段输出）

---

## [6.0] - 2026-01-17 (Stability)

### 变更
- 深化 `<final>` 末尾约束：serp_queries 必须在 `<final>` 内且三行无缩进
- 禁止 ``` 代码块/复述模板，避免重复标签导致解析失败
- 回归：xai 3/3、deepseek 3/3、claude-sonnet 3/3（runs=3, turns=1）

---

## [5.0] - 2026-01-17 (Production)

### 变更
- 最终生产版本，字符数 1026 bytes
- 压缩率 78%（基线 4627 → 1026）
- grok 模型 100% 通过率（10/10，runs=5, turns=2）

### 结构
- 必须输出的完整结构示例前置
- 强制规则精简为 5 条核心要求
- 标签规则、内容规则、禁止事项分块

---

## [4.0] - 2026-01-17

### 变更
- 统一版本，字符数 1261 bytes
- 使用中文描述，提高可读性
- grok 5/5 PASS，gemini-pro 4/5 PASS

---

## [3.1] - 2026-01-17

### 变更
- 强化约束版本，字符数 1402 bytes
- 明确"必须输出"的结构要求
- grok/gemini-pro 均 3/3 PASS

---

## [3.0] - 2026-01-17

### 变更
- 结构优化版本，字符数 1902 bytes
- 使用代码块展示结构顺序
- 分节组织：标签白名单、结构顺序、关键约束

---

## [2.0] - 2026-01-17

### 变更
- 首次压缩版本，字符数 1891 bytes
- 去除冗余说明和重复约束
- 压缩率 59%，但稳定性略有下降

---

## [1.0] - 2026-01-17 (Baseline)

### 内容
- 基线版本，字符数 4627 bytes
- 从 `assets/prompts/serp_prompt.md` 复制
- 包含完整的 ThinkingML v4.5 规范

---

## 迭代总结

| 版本 | 字符数 | 压缩率 | 主要改进 |
|------|--------|--------|----------|
| v1.0 | 4627 | - | 基线 |
| v2.0 | 1891 | 59% | 去冗余 |
| v3.0 | 1902 | 59% | 结构化 |
| v3.1 | 1402 | 70% | 强化约束 |
| v4.0 | 1261 | 73% | 统一简化 |
| v5.0 | 1026 | 78% | 生产就绪 |
| v6.0 | 1500 | 68% | 多模型稳定 |
| v7.0 | 1636 | 65% | claude 去代码围栏 |
| v7.1 | 1903 | 59% | 讨论规范场景稳定 |
| v7.2 | 3073 | 34% | GymBro+SERP+保密 |
| v7.3 | 3828 | 17% | SERP 必须 + meta 兜底 |
