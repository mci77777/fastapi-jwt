ID,Priority,Area,Module/Path,Task,Description,Dependencies,DefinitionOfDone,status,mcp_scan_query,notes,evidence,commit
CLOUD-002,P0,llm-config,app/services/llm_model_registry.py (new),建立 Model Mapping Registry（mapped model -> provider config）SSOT,将当前 gpt/xai/claude/gemini/deepseek 等映射配置收敛到可热更新的数据结构：provider、dialect、real_model、base_url、api_key_ref、capabilities、enabled。并提供管理入口（仅内部/管理员）。,—,"GET /api/v1/llm/models?view=mapped 返回 stable schema（name=dslKey, provider, dialect, capabilities）；后端发起调用时只依赖 registry。",DONE,CLOUD-002 llm_model_registry mapped model provider config SSOT,started_at=2026-01-07T16:32:39+08:00 | Added derived registry over endpoints+mappings; AIService routes via registry; /llm/models includes provider/dialect/capabilities; admin /llm/models/registry.,commit=todo(CLOUD-002): add LlmModelRegistry SSOT done_at=2026-01-07T16:41:02+08:00,todo(CLOUD-002): add LlmModelRegistry SSOT
CLOUD-004,P0,streaming,app/services/ai_service.py + broker,统一对外 SSE：只输出 GymBro 自定义事件（避免官方帧透传）,"无论上游 provider 帧格式如何，对 App/Web 一律输出：status/content_delta/completed/error/heartbeat。content_delta payload 固定为 {delta:string, seq:int?, request_id:string?}，并保证单行 data。",—,App 侧仅需消费 GymBro 事件即可完整显示（仍可保留兼容）；E2E 最小闭环至少 1 个 content_delta + 最终 completed/error。,DONE,CLOUD-004 unify SSE status content_delta completed error heartbeat,started_at=2026-01-07T16:41:58+08:00 | Broker auto-injects message_id/request_id and seq for content_delta; error now has code+message (keeps legacy error); SSE output json is single-line; heartbeat includes ts+request_id.,commit=todo(CLOUD-004): normalize GymBro SSE events done_at=2026-01-07T16:46:46+08:00,todo(CLOUD-004): normalize GymBro SSE events
CLOUD-003,P0,provider-adapters,app/services/providers/*,实现 4 套 Provider Adapter：构建请求 + 解析流式输出,"OpenAI ChatCompletions、OpenAI Responses、Anthropic Messages、Gemini streamGenerateContent。每个 adapter：1) build_request(headers,url,body) 2) stream_parser(raw_sse)→normalized events(content_delta/completed/error)。",CLOUD-004,在 mock provider SSE 下能稳定产出 GymBro SSE 事件；支持工具/结构化输出字段先透传到 metadata（不阻塞文本）。,DONE,CLOUD-003 provider adapters build_request stream_parser normalized events,"started_at=2026-01-07T16:47:21+08:00 | Added 4 provider adapters (openai chat, openai responses, anthropic messages, gemini); AIService streaming now delegates to adapters; tool_calls no longer blocks text (metadata surfaced on completed).",commit=todo(CLOUD-003): add provider adapters done_at=2026-01-07T16:59:34+08:00,todo(CLOUD-003): add provider adapters
CLOUD-001,P0,api-contract,app/api/v1/messages.py + schema,为 /api/v1/messages 增加 dialect + payload(可选) 以支持 4 种请求体,在保持现有 SSOT 顶层字段（text/messages/tools/...）不变的前提下，新增：dialect（openai.chat_completions/openai.responses/anthropic.messages/gemini.generate_content）与 payload（provider 原生 JSON）。当 payload 存在时，走 provider-passthrough 分支；否则走现有 server/passthrough。,"CLOUD-002,CLOUD-003","OpenAPI 与 pydantic 校验清晰；4 种 dialect 均可被解析并进入对应 adapter；错误时返回结构化 error(code, message, request_id)。",,CLOUD-001 messages API add dialect payload provider passthrough,,,
CLOUD-005,P1,models-api,app/api/v1/llm_models.py,扩展 /api/v1/llm/models 返回字段：dialect + endpoint_hint,"让客户端在展示 mapped models 时，明确该模型背后的 dialect（openai/anthropic/gemini）与能力（supports_tools, supports_vision, max_output_tokens）。",CLOUD-002,前端/Android 可据此做 UI 提示或默认 prompt 策略；字段向后兼容。,,CLOUD-005 llm/models add dialect endpoint_hint,,,
CLOUD-006,P1,security,app/core/policy_gate.py + logging,鉴权/限流/脱敏：确保 JWT 校验与 PII/APIKey 不落日志,明确 Cloud 只接受 Bearer JWT；provider api key 仅在服务器端 secret store；日志经 PiiSanitizer 处理；SSE 长连仍豁免 QPS 计数，但并发 guard 生效。,CLOUD-004,安全审计：日志不含 key；匿名与真用户路径行为一致；429/403 错误码稳定。,,CLOUD-006 policy_gate logging PII sanitize JWT API key,,,
CLOUD-007,P1,seed-sync,app/api/v1/seed.py (new) + storage,澄清并固化“动作库种子文件远程更新”契约,新增/确认：seed manifest endpoint（版本、hash、下载 URL、增量策略）。客户端按版本拉取并缓存；云端可远程更新 seed，不影响 AI 链路。,—,有 1) manifest 2) file download 3) ETag/If-None-Match；支持灰度；写入文档并给出回滚策略。,,CLOUD-007 seed manifest endpoint ETag If-None-Match,,,
CLOUD-008,P2,tests,tests/providers + tools/e2e,Provider Adapter 的单测 + Cloud E2E 扩展,为每个 adapter 提供录制的 SSE fixture（或合成），覆盖：正常/断连/超长 JSON 换行/工具调用；并在 e2e 套件中加入 4 dialect smoke。,CLOUD-001~CLOUD-004,CI 可跑；产物包含 request_id 对账与 token 统计；失败可定位到具体 dialect/adapter。,,CLOUD-008 tests provider adapters SSE fixtures e2e dialect smoke,,,
CLOUD-009,P2,docs,docs/api-contracts + openapi,输出 Cloud API 契约与示例（含 4 请求体）,将 /messages 的两种模式（GymBro SSOT vs provider payload）写入 OpenAPI；给出 curl 示例与 SSE 示例。,CLOUD-001~CLOUD-008,文档可直接作为联调手册；示例可被复制运行。,,CLOUD-009 docs API contract examples 4 request bodies,,,
