# ä»»åŠ¡æ‘˜è¦ï¼šExercise Library å®˜æ–¹ç§å­ç‰ˆæœ¬åŒ– + å¢é‡æ›´æ–° APIï¼ˆFastAPIï¼‰

- æ—¥æœŸï¼š2026-01-02
- ç›¸å…³æ¶æ„è¯´æ˜ï¼š`docs/PROJECT_OVERVIEW.md`
- èƒŒæ™¯ï¼šAndroid ç«¯å·²å®ç°â€œå®˜æ–¹ç§å­å¯¼å…¥ + ç‰ˆæœ¬ SSOT + å¢é‡æ›´æ–°ï¼ˆå¤±è´¥å›é€€å…¨é‡ï¼‰â€ï¼Œå¹¶é‡‡ç”¨ **WorkManager æ¯æ—¥ä¸€æ¬¡æ‹‰å–æ£€æµ‹**ï¼ˆé SSE å¸¸é©»æ¨é€ï¼‰ã€‚

## ğŸ¯ ç›®æ ‡ï¼ˆWHYï¼‰

- è®©æœåŠ¡ç«¯å¯ä»¥â€œå‘å¸ƒ/æ›´æ–°å®˜æ–¹åŠ¨ä½œåº“â€ï¼Œå®¢æˆ·ç«¯åœ¨ä¸é¢‘ç¹è¯·æ±‚çš„å‰æä¸‹ï¼ˆ1 å¤© 1 æ¬¡ï¼‰è‡ªåŠ¨åŒæ­¥åˆ°æœ€æ–°ã€‚
- å®˜æ–¹åº“ä¸ç”¨æˆ·è‡ªå®šä¹‰åº“ç‰©ç†/é€»è¾‘éš”ç¦»ï¼šå®˜æ–¹å‘å¸ƒä¸ä¼šæ±¡æŸ“ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®ã€‚

## âœ… å®¢æˆ·ç«¯å·²å›ºå®šçš„å¥‘çº¦ï¼ˆå¿…é¡»åŒ¹é…ï¼‰

> è·¯å¾„å‰ç¼€ï¼š`/api/v1/exercise/library/*`  
> å“åº”ï¼šç›´å‡º JSONï¼Œä¸åŒ…è£¹ `code/data` äºŒå±‚ç»“æ„ï¼›å­—æ®µ camelCaseã€‚

1) `GET /api/v1/exercise/library/meta`
- è¿”å›ï¼š`{ "version": <int>, "totalCount": <int>, "lastUpdated": <long(ms)>, "checksum": <string>, "downloadUrl": <string|null> }`
- è¯­ä¹‰ï¼šæœåŠ¡ç«¯å½“å‰â€œå®˜æ–¹åº“å¿«ç…§â€çš„æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼ˆversion å•è°ƒé€’å¢ï¼‰ã€‚

2) `GET /api/v1/exercise/library/full`
- è¿”å›ï¼š`List[ExerciseDto]`ï¼ˆä¸ App ä¾§ `ExerciseDto` å­—æ®µå¯¹é½ï¼‰
- è¯­ä¹‰ï¼šè¿”å›æœ€æ–°ç‰ˆæœ¬çš„å®Œæ•´å®˜æ–¹åº“ï¼ˆç”¨äºå®¢æˆ·ç«¯å›é€€å…¨é‡è¦†ç›–ï¼‰ã€‚

3) `GET /api/v1/exercise/library/updates?from=<int>&to=<int>`
- è¿”å›ï¼š`{ "fromVersion": <int>, "toVersion": <int>, "added": List[ExerciseDto], "updated": List[ExerciseDto], "deleted": List[string], "timestamp": <long(ms)> }`
- è¯­ä¹‰ï¼šä» `from` åˆ° `to` çš„å¢é‡ diffï¼ˆå®¢æˆ·ç«¯ä¼šæŒ‰ `id` åˆ é™¤/æ‰¹é‡ upsertï¼‰ã€‚
- å…¼å®¹ï¼šè‹¥ `from` è¿‡æ—§æˆ– diff ä¸å¯å¾—ï¼Œå¯è¿”å› 4xx/5xx è§¦å‘å®¢æˆ·ç«¯è‡ªåŠ¨å›é€€ `full`ã€‚

## ğŸ§± æ•°æ®/ç‰ˆæœ¬ SSOTï¼ˆå»ºè®®å®ç°ï¼‰

### 1) å®˜æ–¹åº“å‘å¸ƒ SSOT
- å»ºè®®å¼•å…¥â€œå®˜æ–¹åº“ç‰ˆæœ¬è¡¨â€ï¼ˆsnapshot å…ƒä¿¡æ¯ï¼‰ï¼Œè‡³å°‘åŒ…å«ï¼š
  - `version`ï¼ˆintï¼Œä¸»é”®/å”¯ä¸€ï¼Œå•è°ƒé€’å¢ï¼‰
  - `checksum`ï¼ˆå¯¹ canonical JSON çš„ hashï¼Œç”¨äºä¸€è‡´æ€§æ ¡éªŒ/ç¼“å­˜ï¼‰
  - `generated_at`ã€`total_count`
  - `payload_location`ï¼ˆå¯é€‰ï¼šæ–‡ä»¶è·¯å¾„/å¯¹è±¡å­˜å‚¨ keyï¼‰

### 2) diff ç”Ÿæˆè§„åˆ™ï¼ˆSSOT=åŒä¸€å¥—ç®—æ³•ï¼‰
- Keyï¼š`ExerciseDto.id` ä½œä¸ºä¸»é”®ã€‚
- åˆ¤å®šï¼š
  - `added`ï¼šæ–°ç‰ˆæœ¬å­˜åœ¨ã€æ—§ç‰ˆæœ¬ä¸å­˜åœ¨
  - `deleted`ï¼šæ—§ç‰ˆæœ¬å­˜åœ¨ã€æ–°ç‰ˆæœ¬ä¸å­˜åœ¨
  - `updated`ï¼šä¸¤ç‰ˆæœ¬å‡å­˜åœ¨ä½†å­—æ®µå†…å®¹ä¸åŒï¼ˆå»ºè®®å¯¹ canonical JSON åš hash å¯¹æ¯”ï¼‰
- æ³¨æ„ï¼šå®¢æˆ·ç«¯åªå…³å¿ƒ id + å­—æ®µæœ€ç»ˆå€¼ï¼›ä¸éœ€è¦å¤æ‚ merge è¯­ä¹‰ã€‚

## ğŸ“¦ â€œå‘å¸ƒæ–°ç§å­â€çš„å…¥å£ï¼ˆç®¡ç†ç«¯/è„šæœ¬ï¼‰

> æœ¬ä»»åŠ¡ä¸å¼ºåˆ¶ UIï¼Œä½†å¿…é¡»å…·å¤‡å¯å›æ”¾çš„å‘å¸ƒæ‰‹æ®µï¼ˆè„šæœ¬/ç®¡ç† API äºŒé€‰ä¸€ï¼‰ã€‚

å»ºè®®äºŒé€‰ä¸€ï¼š
1) **è„šæœ¬å‘å¸ƒï¼ˆä¼˜å…ˆ KISSï¼‰**ï¼šæä¾› `scripts/publish_exercise_seed.py`ï¼ˆè¯» seed.json â†’ ç”Ÿæˆ version+checksum+diff â†’ å†™å…¥ DB/æ–‡ä»¶ï¼‰ã€‚
2) **ç®¡ç† API å‘å¸ƒ**ï¼ˆéœ€è¦é‰´æƒï¼‰ï¼š
   - `POST /api/v1/admin/exercise/library/publish`ï¼šä¸Šä¼  seed JSONï¼ˆå·²å®ç°ï¼‰
   - è¿”å›æ–° `meta`ï¼ˆversion/checksum/totalCountï¼‰

å®ç°çº¦å®šï¼ˆç°çŠ¶ SSOTï¼‰ï¼š
- é‰´æƒï¼šä»… `admin` ç”¨æˆ·å¯ç”¨ï¼ˆDashboard æœ¬åœ°è´¦å· / JWT `user_metadata.is_admin=true`ï¼‰ã€‚
- è¯·æ±‚å¤´ï¼šæ”¯æŒ `token: <jwt>` æˆ– `Authorization: Bearer <jwt>`ã€‚
- è¯·æ±‚ä½“ï¼šæ”¯æŒç›´æ¥ä¼  `List[ExerciseDto]` æ•°ç»„ï¼Œæˆ– `{ "items": [...] }` / `{ "payload": [...] }` / `{ "exercises": [...] }`ã€‚

### å¢é‡ Patch å‘å¸ƒï¼ˆå¯é€‰ï¼‰
- `POST /api/v1/admin/exercise/library/patch`ï¼šç”¨ `{ baseVersion, added, updated, deleted, generatedAt? }` å‘å¸ƒæ–°ç‰ˆæœ¬ã€‚
  - `baseVersion` å¿…é¡»ç­‰äºå½“å‰ `meta.version`ï¼ˆå¦åˆ™ 409ï¼‰ï¼Œç”¨äºé¿å…å¹¶å‘è¦†ç›–ã€‚
  - `updated` æŒ‰ `id` åŒ¹é…ï¼Œä»…è¦†ç›–æä¾›çš„å­—æ®µï¼ˆæœªæä¾›å­—æ®µä¿æŒä¸å˜ï¼‰ã€‚

## ğŸ” é‰´æƒä¸ç­–ç•¥

- å®¢æˆ·ç«¯ä¾§è¯¥æ¥å£å±äº App åŸºç¡€èƒ½åŠ›ï¼Œå»ºè®®å¯¹åŒ¿åç”¨æˆ·ä¹Ÿå¯è¯»ï¼ˆä¸ç°æœ‰ PolicyGate ç­–ç•¥ä¿æŒä¸€è‡´ï¼‰ï¼Œä½†åº”èµ°é™æµã€‚
- å‘å¸ƒå…¥å£å¿…é¡»è¦æ±‚æ°¸ä¹…ç”¨æˆ·/ç®¡ç†å‘˜æƒé™ã€‚

## ğŸ§ª éªŒè¯ä¸éªŒæ”¶ï¼ˆDONEï¼‰

1) å†’çƒŸ
- `GET /api/v1/exercise/library/meta` è¿”å› `version >= 1`
- `GET /api/v1/exercise/library/full` è¿”å›éç©ºåˆ—è¡¨ï¼Œå­—æ®µå¯è¢« App è§£æ
- `GET /api/v1/exercise/library/updates?from=0&to=<meta.version>` å¯ç”¨æˆ–æ˜ç¡®å¤±è´¥ï¼ˆè§¦å‘å®¢æˆ·ç«¯å›é€€ fullï¼‰

2) åˆçº¦æµ‹è¯•ï¼ˆæ¨èï¼‰
- æ–°å¢ `tests/test_exercise_library_contracts.py`ï¼š
  - meta/full/updates çš„ schema æ ¡éªŒï¼ˆå­—æ®µã€ç±»å‹ã€åˆ—è¡¨ç»“æ„ï¼‰
  - diff è§„åˆ™ï¼šadded/updated/deleted ä¸ç›¸äº¤ï¼›deleted åªåŒ…å«å­—ç¬¦ä¸² id

## ğŸ“ å¤‡æ³¨ï¼ˆå®¢æˆ·ç«¯ä¾§å®ç°æç¤ºï¼‰

- official idï¼šå½“å‰å®˜æ–¹ seed ä½¿ç”¨ `off_${md5(name).take(8)}`ï¼ˆUTF-8ï¼Œå– 8 ä½åå…­è¿›åˆ¶å°å†™ï¼‰ï¼›æ›´æ¨èç›´æ¥ä»¥ seed ä¸­çš„ `id` ä¸ºå‡†ï¼Œé¿å…å¤šè¯­è¨€å®ç°æ¼‚ç§»ã€‚
- App ä¾§æ¯å¤©åªæ£€æµ‹ä¸€æ¬¡ï¼ˆèŠ‚æµ SSOT=æœ¬åœ° prefs çš„ `last_check_at_ms`ï¼‰ï¼Œä¸ä¾èµ– SSE æ¨é€ã€‚
