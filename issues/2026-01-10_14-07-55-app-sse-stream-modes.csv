ID,Title,Description,Acceptance,Test_Method,Tools,Dev_Status,Review1_Status,Regression_Status,Files,Dependencies,Notes
A1,SSOT：新增输出模式开关,在 `POST /api/v1/messages` 请求体新增 `result_mode`（raw_passthrough/xml_plaintext/auto）并固化到 broker meta；定义 SSE 事件协议与兼容策略（新增 event 需兼容旧客户端）。,能够通过同一 message_id 在 SSE 端读到被固化的模式；默认行为符合“替代现有功能”设定；无影子状态。,新增/更新 API 合约测试；手动 curl 创建消息并订阅 SSE 验证 `status`/模式标记。,feedback:codebase-retrieval;functions:apply_patch;functions:shell_command,TODO,TODO,TODO,app/api/v1/messages.py;app/services/ai_service.py;docs/sse/README.md,依赖现有 broker SSOT 与 SSE 契约文档,输出模式开关需与 promptMode 同语义域（透传/不透传同位置）。
A2,实现：RAW 透明流式转发,provider adapters 统一产出上游 RAW 帧并在 `result_mode=raw_passthrough` 下以流式事件发给 App（可还原）；上游非 SSE 时也必须分块流式输出（禁止一次性）。,raw_passthrough 下 App 端能连续收到多条增量事件；RAW 可重放/还原；上游非 SSE 时仍持续分块输出。,E2E：mock 上游多帧 SSE 与一次性 JSON 两种情形，断言下游事件数量>1 且分布连续。,feedback:codebase-retrieval;functions:apply_patch;functions:shell_command,TODO,TODO,TODO,app/services/providers/*.py;app/services/providers/sse.py;app/services/ai_service.py;app/api/v1/messages.py,依赖现有 httpx stream 与 SSE parser,注意隐私：RAW 不落盘/不进 debug frames；仅记录长度与 ts。
A3,实现：解析后 XML 纯文本流式输出,后端在接收上游 RAW/解析帧后，输出“包含 XML 标签的纯文本”给 App（`result_mode=xml_plaintext`）；若检测解析失败自动降级 raw 并发 status 标记。,xml_plaintext 下 App 端拼接得到的 reply 为纯文本且包含 XML 标签（例如 `<final>`）；解析失败时自动降级且客户端可感知原因。,E2E：mock 上游多帧 SSE，断言 content_delta 拼接包含 `<final>`；mock 异常帧触发降级并断言 status。,feedback:codebase-retrieval;functions:apply_patch;functions:shell_command,TODO,TODO,TODO,app/services/ai_service.py;app/api/v1/messages.py;docs/sse/app_ai_sse_raw_结构体与样本.md,依赖现有 ThinkingML/Strict XML 结构 SSOT,解析模式必须走流式（不得收集后一次性输出）。
A4,自动检测点与节流切分,增加检测点：上游是否 SSE、delta 粒度是否过大/间隔过长；必要时对大块 delta 二次切分，保证 App 端“持续流式”体验。,同一响应周期内无长时间空白；delta 平均长度符合阈值；日志可对账（AI_CHUNK_RECEIVED vs SSE_DELTA_SENT）。,E2E：构造大块 delta，断言服务端切分后事件数增加且 seq 单调；对比时间戳/间隔（允许阈值范围）。,feedback:codebase-retrieval;functions:apply_patch;functions:shell_command,TODO,TODO,TODO,app/services/ai_service.py;app/services/ai_service.py;app/api/v1/messages.py,依赖现有 MessageEventBroker seq 机制,切分阈值需可配置且默认保守（避免事件风暴）。
A5,测试闭环与发布前置探针,将 `/api/v1/base/sse_probe` 作为发布前置验收；新增 `tests/test_sse_output_modes_e2e.py` 覆盖 raw/xml/降级三路径并回归现有 SSE 微型 E2E。,本地与 CI 通过所有相关测试；探针在真实网络路径下按 1s 间隔到达（用于判责代理缓冲）。,pytest：新增用例 + 回归现有 `tests/test_app_models_messages_sse_micro_e2e.py`；手动运行 probe 验证。,feedback:codebase-retrieval;functions:shell_command,TODO,TODO,TODO,tests/test_sse_output_modes_e2e.py;docs/sse/README.md;deploy/web.conf,依赖部署层关闭缓冲/压缩（proxy_buffering off; gzip off）,若 probe 仍被合并一次性到达：先修网关/边缘层再继续后端优化。
