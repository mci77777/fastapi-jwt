ID,Title,Description,Acceptance,Test_Method,Tools,Dev_Status,Review1_Status,Regression_Status,Files,Dependencies,Notes
A1,SSOT：/agent 合约与结构体落地,定义 Agent Run 的 request/response 与 SSE 事件集合（含 tool_start/tool_result）；并输出可机读 JSON Schema 与对外文档。,文档与 schema 能约束字段与事件形状；包含 request_id/run_id/conversation_id；新增事件不破坏现有 messages SSE。,Schema 校验：为 request/response/events 新增 schema 并在测试中做 validate；文档对齐现有 ai 预期响应结构。,feedback:codebase-retrieval;functions:apply_patch;functions:shell_command,TODO,TODO,TODO,docs/api-contracts/README.md;docs/api-contracts/api_gymbro_cloud_conversation_min_contract.md;docs/api-contracts/schemas/*agent*.schema.json,依赖现有 SSE SSOT 与错误结构体约定,事件命名沿用 status/content_delta/completed/error；新增 tool_* 为可选扩展。
A2,实现：Agent Run 创建与 SSE 订阅,新增 `/api/v1/agent/runs` 创建入口与 `/api/v1/agent/runs/{run_id}/events` SSE；内部复用 MessageEventBroker 产出事件流。,创建后可订阅到完整事件链路（status→tool_*→content_delta→completed|error）；支持心跳与并发限制复用现有策略门/限流。,集成测试：启动后端后创建 run 并订阅 SSE；断言事件序列与字段齐全；断言 completed/error 终止事件必达。,feedback:codebase-retrieval;functions:apply_patch;functions:shell_command,TODO,TODO,TODO,app/api/v1/*agent*.py;app/services/*agent*.py;app/services/ai_service.py;app/core/policy_gate.py;app/core/rate_limiter.py,依赖现有 MessageEventBroker 与 request_id 透传,优先 SSE；WebSocket 仅保留后续扩展（中断/补充输入）。
A3,工具：动作库检索（后端执行）,为 agent 工具实现 exercise library 的 search/get_detail（基于最新快照或 seed）；返回结构体对 App 友好（id/name/snippet 等）。,工具可在毫秒级返回命中列表与详情；异常返回统一错误码且不会破坏 SSE 流；不新增对外 API（内部工具即可）。,单测：对 search/get_detail 输入做多条件覆盖（name/muscleGroup/equipment/difficulty）；断言返回字段与排序稳定。,feedback:codebase-retrieval;functions:apply_patch;functions:shell_command,TODO,TODO,TODO,app/services/exercise_library_service.py;assets/exercise/exercise_official_seed.json;docs/后端方案/动作库-种子数据库scheme-后端须知.md,依赖现有 exercise_library 快照 SSOT,避免引入 FTS 大工程；v1 用内存/遍历筛选即可。
A4,工具：Web 搜索（Exa+缓存+限流）,后端实现 web_search 工具：provider 固定为 Exa（`EXA_API_KEY` 环境变量）；带 TTL 缓存与用户级配额/限流；输出最小结果列表（title/url/snippet/source/ts）。,无 key 时可用 mock 跑通全链路；提供 key 且启用外网搜索时可稳定返回结果；缓存命中可显著降低外部调用次数。,E2E：mock provider 返回固定结果并在 SSE 中出现 tool_result；Exa 仅做手工冒烟（不进 CI 且不打印 key）。,feedback:codebase-retrieval;functions:apply_patch;functions:shell_command;functions:mcp__context7__resolve-library-id;functions:mcp__context7__get-library-docs,TODO,TODO,TODO,app/services/*web_search*.py;app/settings/config.py;docs/*websearch*.md,依赖 Exa API Key 与费用策略,默认关闭外网搜索；只返回摘要不抓取全文以控成本与风险。
A5,验收：端到端回归与可观测,补齐测试与探针：保证终止事件必达；对 tool_* 与 content_delta 拼接后的 ThinkingML 输出做结构校验；记录关键指标（命中率/外呼次数/耗时）。,make test 通过；/agent 全链路可复现且可对账；失败路径也能返回 error 事件并携带 request_id。,pytest：新增 agent SSE 用例；必要时新增本地脚本做冒烟；手动 curl 验证 SSE 心跳与终止事件。,feedback:codebase-retrieval;functions:apply_patch;functions:shell_command,TODO,TODO,TODO,tests/test_*.py;scripts/*agent*.py;docs/ai预期响应结构.md,依赖现有 SSE 终止保障与 metrics 框架,禁止以日志为主要定位手段；测试断言事件与结构体为准。
