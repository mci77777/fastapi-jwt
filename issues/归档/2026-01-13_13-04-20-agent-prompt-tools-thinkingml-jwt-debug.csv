ID,Title,Description,Acceptance,Test_Method,Tools,Dev_Status,Review1_Status,Regression_Status,Files,Dependencies,Notes
A1,SSOT：Prompt/Tools 组装器统一,将 `/messages` 与 `Prompt Test` 的 system+tools 文本拼接、tools_json 注入、tool_choice gating 统一到同一处实现，避免两套逻辑漂移。,任意一组同配置下 `/messages` 与 `Prompt Test` 对上游 payload 的关键字段一致（system 内容、tools 是否发送、tool_choice 行为）。,pytest：构造同样 active prompts + 请求参数，断言上游 payload 等价（mock httpx，不出网）。,functions:shell_command;functions:apply_patch;feedback:codebase-retrieval,TODO,TODO,TODO,app/services/ai_service.py;app/services/ai_config_service.py;tests/*,Active prompts（system/tools）,默认走 OpenAI chat completions；避免引入新协议。
A2,Agent：默认 Strict XML + 工具上下文注入,为 `/agent/runs` 增加“严格输出 ThinkingML v4.5”提示（与 assets/prompts/serp_prompt.md 对齐），并将工具结果以内部 XML/安全文本注入输入侧，避免污染输出标签计数。,Agent Run 开启工具时仍输出且仅输出一个 `<thinking>...</thinking><final>...</final>`（含 serp_queries 注释块），前端校验通过。,脚本：扩展 scripts/monitoring/local_mock_ai_conversation_e2e.py 覆盖 /agent/runs；pytest：agent run SSE 拼接后跑 validator。 ,functions:shell_command;functions:apply_patch;feedback:codebase-retrieval,TODO,TODO,TODO,app/api/v1/agent_runs.py;assets/prompts/*;tests/*,MessageEventBroker（ThinkingML sanitize）,优先依赖 Dashboard active prompts；缺失时要有可控兜底。
A3,JWT 测试页：工具测试可视化与默认一致性,在 `/ai/jwt` 增加 Agent/Tools tab：默认走 `/agent/runs` + server prompt + xml_plaintext，并独立展示 tool_start/tool_result（结构化）；提供“与 Dashboard 一致/自定义覆盖”的组合选项。,页面一键跑通：选择模型→Agent Run→看到 tool 事件→最终校验 PASS；切换到 `/messages` 作为基线对照不影响原功能。,手动：浏览器验证；可选 e2e：通过 mock 后端响应验证 UI 状态机。,functions:apply_patch;functions:shell_command,TODO,TODO,TODO,web/src/views/ai/model-suite/jwt/RealUserSseSsot.vue;web/src/api/aiModelSuite.js,后端新增 prompt/tools 预览只读 API（如实现）,避免 JWT 页使用自定义 prompt 通过但 Dashboard 不行。
A4,文档：Agent Prompt/Tools 与调试指南,补充 docs：解释 Prompt/Tools SSOT、Agent Run 事件与 JWT 调试流程、常见校验失败原因（invalid_thinking_block_count 等）与排查步骤。,文档在 ./docs 下可直接指向文件路径，按步骤可复现与定位问题。,检查：docs 与实际端点/字段一致；本地 docker 重建后按文档冒烟通过。,functions:apply_patch;functions:shell_command,DONE,TODO,TODO,docs/AGENT_RUN_DEBUG_WEB.md;docs/api-contracts/*,现有契约文档,后续可把常见错误映射到 UI 友好提示。
