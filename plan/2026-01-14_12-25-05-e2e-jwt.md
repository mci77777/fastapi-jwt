---
mode: plan
task: 每日E2E JWT模型映射可用性测试
created_at: "2026-01-14T12:25:05+08:00"
complexity: complex
---

# Plan: 每日E2E JWT模型映射可用性测试

## Goal
- 每天 05:00 自动执行一条仅含普通对话的 E2E 测试，覆盖匿名/普通用户注册与 JWT 获取、system prompt 组装、可配置请求语句，结果落地 SQLite 并可在 dashboard 查看。

## Scope
- In:
- 后端新增/复用 E2E 任务入口与调度、SQLite 存储结构、可配置测试 prompt、JWT 获取流程封装（匿名/普通注册）。
- dashboard/分区相关配置（按项目既有模式）。
- Out:
- 不新增复杂工作流/多模型并发；不扩展到非 message 端点。

## Assumptions / Dependencies
- 现有脚本（如 `scripts/smoke_test.py`）可复用为 E2E 基线；需同义实现扫描确认。
- SQLite 作为现有 SSOT 可新增表并通过 Aerich 迁移。
- 调度机制（应用内/系统 cron）与时区需在实施前确认。
- “分区”含义需明确（Grafana/Prometheus 分区或前端 dashboard 分区）。
- `docs/mcp-tools.md` 当前缺失，后续生成以填充工具名。

## Phases
1. 规则与现状扫描：读取 `AGENTS.md`、`docs/PROJECT_OVERVIEW.md`、`docs/JWT_HARDENING_GUIDE.md`、`docs/GW_AUTH_README.md`；同义实现扫描现有 E2E/冒烟脚本、定时任务、dashboard 配置与 SQLite 表。
2. 端到端链路最小实现：新增/复用 E2E 流程（匿名/普通注册→JWT→/api/v1/messages 对话），system prompt 组装与可配置请求语句；结果落 SQLite；提供一次性手动触发入口。
3. 调度与可观测：设置每日 05:00 触发（按确认的时区/机制）；新增分区/dashboard 配置；补齐文档与回滚路径。

## Tests & Verification
- 构建或启动成功：`python run.py` + `GET /api/v1/healthz`=200（或 `make test`）。
- 手动触发 E2E 任务 -> SQLite 记录落库且字段完整。
- 校验匿名/普通 JWT 获取链路与消息对话返回正常。

## Issue CSV
- Path: issues/2026-01-14_12-25-05-e2e-jwt.csv
- Must share the same timestamp/slug as this plan.

## Tools / MCP
- `mcp__feedback__codebase-retrieval`：同义实现扫描/定位入口
- `functions.shell_command`：只读检索与验证
- `functions.apply_patch`：最小改动（如需）
- `mcp__context7__resolve-library-id` + `mcp__context7__get-library-docs`：如引入调度库需校验官方用法
- 说明：待生成 `docs/mcp-tools.md` 后补齐标准工具名

## Acceptance Checklist
- [ ] 每天 05:00 自动执行，且可手动触发
- [ ] 覆盖匿名/普通注册 + JWT 获取 + system prompt 组装 + 可配置请求语句
- [ ] 仅走 message 普通对话端点
- [ ] SQLite 有结果记录，可回溯
- [ ] 分区/dashboard 配置完成且可验证

## Risks / Blockers
- “分区”含义不清；SQLite 不支持传统分区，需确认目标。
- 调度机制选择（系统 cron/应用内调度）与时区未明确。
- 外部依赖（注册/鉴权）波动影响 E2E 稳定性。

## Rollback / Recovery
- 单提交回滚；移除任务调度与新增表/迁移；禁用触发入口。

## Checkpoints
- Commit after: Phase 2（E2E 任务 + SQLite 落库完成）

## References
- `AGENTS.md`
- `docs/PROJECT_OVERVIEW.md`
- `docs/JWT_HARDENING_GUIDE.md`
- `docs/GW_AUTH_README.md`
- `docs/SCRIPTS_INDEX.md`
