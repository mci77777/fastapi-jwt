---
mode: plan
task: 模型映射本地JSON导入
created_at: "2026-01-19T20:04:12+08:00"
complexity: medium
---

# Plan: 模型映射本地 JSON 导入

## Goal
- 在模型映射页面新增“导入本地 JSON”，将本地 JSON 写入后端 SSOT（Prompt tools_json + SQLite），导入后可立即在列表中看到结果，并返回可观测的统计与错误摘要。

## Scope
- In:
- 后端新增“本地 JSON 导入”API（管理员权限）
- 解析并写入：复用 `ModelMappingService.upsert_mapping()`/SQLite 写入路径（SSOT）
- 前端新增导入按钮 + 文件选择 + 调用 API + 刷新列表
- 新增/补齐后端测试用例（导入成功/失败/部分无效）
- Out:
- 复杂冲突解决（逐条交互合并/差异预览）
- 大文件流式导入/分片上传
- 导入历史审计表/数据库 schema 变更（本需求不引入迁移）

## Assumptions / Dependencies
- 导入格式以当前“导出本地 JSON”产物为准：顶层含 `mappings: []`（允许 `exported_at` 等额外字段）。
- 导入语义为 upsert 合并；不做 delete_missing。
- 仅管理员可导入（`require_llm_admin`）。

## Phases
1. 契约确认与同义实现扫描（是否已有导入/解析模式）
2. 后端：导入 API + 服务方法 + 结果统计与错误摘要
3. 前端：导入 UI + API 接入 + 导入后刷新
4. 测试与验收：pytest + 启动健康检查

## Tests & Verification
- JSON 导入成功（至少 1 条 mapping/module/prompt） -> `pytest -q` 指定新增测试
- JSON 解析失败 -> 返回 422 + 明确错误码/消息
- 部分无效条目 -> 返回 `imported_count/skipped_count/errors[]`，且有效条目可写入
- 回归 -> `make test`
- 启动验收 -> `make start` + `curl http://localhost:9999/api/v1/healthz`

## Issue CSV
- Path: issues/2026-01-19_20-04-12-json.csv
- Must share the same timestamp/slug as this plan.

## Tools / MCP
- feedback:codebase-retrieval（同义实现扫描/定位调用点）
- context7:resolve-library-id + context7:query-docs（如需核验 FastAPI/Pydantic 边界）

## Acceptance Checklist
- [ ] Web 模型映射页新增“导入本地 JSON”，可选择文件并完成导入
- [ ] 后端新增导入 API（管理员权限），返回导入统计与错误摘要
- [ ] 导入后列表刷新可见，且不引入影子状态/不改动 SSOT
- [ ] `make test` 通过，服务启动与 `/api/v1/healthz` 正常

## Risks / Blockers
- JSON 格式多版本（导出文件 vs legacy `model_mappings.json`）导致解析分歧
- prompt 类型导入可能引用不存在的 prompt_id（需跳过并记录错误）

## Rollback / Recovery
- 导入前使用“导出本地 JSON”备份；回滚可重新导入备份
- 代码回滚：单提交 revert

## Checkpoints
- Commit after: Phase 2 / Phase 3

## References
- app/services/model_mapping_service.py:692
- app/api/v1/llm_mappings.py:47
- web/src/views/ai/model-suite/mapping/index.vue:157
