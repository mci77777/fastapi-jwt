---
mode: plan
task: JWT 测试：匿名当日复用 + SSE 429 修复 + 502 触发链路验证
created_at: "2026-01-02T15:39:30+08:00"
complexity: medium
---

# Plan: JWT 测试：匿名当日复用 + SSE 429 修复 + 502 触发链路验证

## Goal
- 在 `https://web.gymbro.cloud/ai/jwt` 完成“获取真实 JWT → 选择端点/模型 → 发起对话 → SSE 收到 completed”的闭环；匿名模式当日复用；SSE 不再因限流返回 429；按钮触发失败不再被 Cloudflare 5xx HTML 吞掉关键信息。

## Scope
- In:
  - 后端：`/api/v1/messages/*/events` 豁免 QPS/日限流计数（并发仍由 `sse_guard` 控制）。
  - 后端：匿名 Supabase JWT 一键生成并在本地 SQLite 持久化“当日复用 / 可强制新建”。
  - 部署：复用现有 Docker（仅重建/重启 app），校验 FRP 映射可用。
- Out:
  - 不新增/重建 Docker 体系或 Cloudflare 配置。

## Assumptions / Dependencies
- 已正确配置并可访问：`SUPABASE_URL/SUPABASE_ANON_KEY/SUPABASE_SERVICE_ROLE_KEY`、`MAIL_API_KEY`。
- FRP 已运行且把本机容器端口映射到 `web.gymbro.cloud`。

## Phases
1. 固化 SSE 429 修复并提交分支。
2. 实装匿名当日复用：SQLite 存储 refresh_token，并在当天优先 refresh 复用。
3. 复用现有 Docker：`docker compose up -d --build app`，本地探针验证。
4. 通过 `web.gymbro.cloud` 复测按钮链路与 SSE。

## Tests & Verification
- `docker compose ps` 显示 `app` healthy。
- `curl http://localhost/api/v1/healthz` 返回 200。
- `POST /api/v1/llm/tests/anon-token`：当日重复调用返回可用 access_token，且不无限创建匿名用户；`force_new=true` 可新建。
- `/ai/jwt`：发送消息后 `GET /api/v1/messages/{id}/events` 不出现 429，并能接收 `completed`。

## Issue CSV
- Path: issues/2026-01-02_15-39-30-jwt-sse-429-502.csv
- Must share the same timestamp/slug as this plan.

## Tools / MCP
- functions:exec_command（构建/探针/日志/部署）
- functions:apply_patch（最小代码改动）

## Acceptance Checklist
- [ ] `/api/v1/messages/*/events` 不再被 RateLimiter 返回 429
- [ ] 匿名 JWT 当日复用，后端持久化一天（可强制新建）
- [ ] `create-mail-user`/匿名链路失败时能返回 JSON 错误体（含 request_id/hint）
- [ ] Docker 重启后本地 SQLite 数据不丢（models/users 可复用）

## Risks / Blockers
- FRP 断连/服务器侧转发异常会导致 Cloudflare 502（需先验证本机容器与隧道状态）。

## Rollback / Recovery
- `git revert <commit>` 后 `docker compose up -d --build app`。

## Checkpoints
- Commit after: Phase 1（SSE 429）与 Phase 2（匿名持久化）。

## References
- app/core/rate_limiter.py
- app/core/sse_guard.py
- app/api/v1/llm_tests.py
- web/src/views/test/real-user-sse.vue
