<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token è¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .status {
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            margin: 10px 0;
        }
        .token-preview {
            word-break: break-all;
            background: #fff;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Token è¯Šæ–­å·¥å…·</h1>
        <p class="subtitle">å¿«é€Ÿè¯Šæ–­å’Œä¿®å¤ JWT è®¤è¯é—®é¢˜</p>

        <!-- è¯Šæ–­ç»“æœ -->
        <div class="section">
            <h2>ğŸ“Š è¯Šæ–­ç»“æœ</h2>
            <div id="diagnosisResult">
                <div class="status status-info">ç‚¹å‡»"å¼€å§‹è¯Šæ–­"æŒ‰é’®æ£€æŸ¥ Token çŠ¶æ€</div>
            </div>
        </div>

        <!-- Token è¯¦æƒ… -->
        <div class="section">
            <h2>ğŸ”‘ Token è¯¦æƒ…</h2>
            <div id="tokenDetails">
                <div class="status status-info">ç­‰å¾…è¯Šæ–­...</div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="section">
            <h2>ğŸ› ï¸ æ“ä½œ</h2>
            <button onclick="diagnose()">ğŸ” å¼€å§‹è¯Šæ–­</button>
            <button onclick="clearToken()" class="btn-danger">ğŸ—‘ï¸ æ¸…é™¤ Token</button>
            <button onclick="goToLogin()" class="btn-success">ğŸ” å‰å¾€ç™»å½•</button>
        </div>

        <!-- è§£å†³æ–¹æ¡ˆ -->
        <div class="section">
            <h2>ğŸ’¡ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</h2>
            <div id="solutions"></div>
        </div>
    </div>

    <script>
        // è¯Šæ–­ Token çŠ¶æ€
        function diagnose() {
            const resultDiv = document.getElementById('diagnosisResult');
            const detailsDiv = document.getElementById('tokenDetails');
            const solutionsDiv = document.getElementById('solutions');

            resultDiv.innerHTML = '<div class="status status-info">æ­£åœ¨è¯Šæ–­...</div>';
            detailsDiv.innerHTML = '';
            solutionsDiv.innerHTML = '';

            try {
                // 1. æ£€æŸ¥ localStorage ä¸­çš„ token
                const tokenKey = 'ACCESS_TOKEN';
                const tokenItem = localStorage.getItem(tokenKey);

                if (!tokenItem) {
                    resultDiv.innerHTML = `
                        <div class="status status-error">
                            âŒ æœªæ‰¾åˆ° Token<br>
                            localStorage ä¸­æ²¡æœ‰ "${tokenKey}" é”®
                        </div>
                    `;
                    solutionsDiv.innerHTML = `
                        <div class="status status-warning">
                            <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                            1. ç‚¹å‡»"å‰å¾€ç™»å½•"æŒ‰é’®<br>
                            2. ä½¿ç”¨ admin / 123456 ç™»å½•<br>
                            3. ç™»å½•æˆåŠŸåä¼šè‡ªåŠ¨ä¿å­˜ Token
                        </div>
                    `;
                    return;
                }

                // 2. è§£æ token å¯¹è±¡
                let tokenData;
                try {
                    tokenData = JSON.parse(tokenItem);
                } catch (e) {
                    resultDiv.innerHTML = `
                        <div class="status status-error">
                            âŒ Token æ ¼å¼é”™è¯¯<br>
                            æ— æ³•è§£æ JSON: ${e.message}
                        </div>
                    `;
                    solutionsDiv.innerHTML = `
                        <div class="status status-warning">
                            <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                            1. ç‚¹å‡»"æ¸…é™¤ Token"æŒ‰é’®<br>
                            2. ç‚¹å‡»"å‰å¾€ç™»å½•"é‡æ–°ç™»å½•
                        </div>
                    `;
                    return;
                }

                const token = tokenData.value;
                if (!token) {
                    resultDiv.innerHTML = `
                        <div class="status status-error">
                            âŒ Token å€¼ä¸ºç©º<br>
                            localStorage ä¸­çš„ token.value ä¸å­˜åœ¨
                        </div>
                    `;
                    solutionsDiv.innerHTML = `
                        <div class="status status-warning">
                            <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                            1. ç‚¹å‡»"æ¸…é™¤ Token"æŒ‰é’®<br>
                            2. ç‚¹å‡»"å‰å¾€ç™»å½•"é‡æ–°ç™»å½•
                        </div>
                    `;
                    return;
                }

                // 3. è§£ç  JWT
                const parts = token.split('.');
                if (parts.length !== 3) {
                    resultDiv.innerHTML = `
                        <div class="status status-error">
                            âŒ Token æ ¼å¼æ— æ•ˆ<br>
                            JWT åº”è¯¥åŒ…å« 3 ä¸ªéƒ¨åˆ†ï¼ˆheader.payload.signatureï¼‰ï¼Œå½“å‰åªæœ‰ ${parts.length} ä¸ªéƒ¨åˆ†
                        </div>
                    `;
                    solutionsDiv.innerHTML = `
                        <div class="status status-warning">
                            <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                            1. ç‚¹å‡»"æ¸…é™¤ Token"æŒ‰é’®<br>
                            2. ç‚¹å‡»"å‰å¾€ç™»å½•"é‡æ–°ç™»å½•
                        </div>
                    `;
                    return;
                }

                // è§£ç  header å’Œ payload
                const decode = (str) => {
                    try {
                        return JSON.parse(atob(str.replace(/-/g, '+').replace(/_/g, '/')));
                    } catch (e) {
                        throw new Error(`è§£ç å¤±è´¥: ${e.message}`);
                    }
                };

                let header, payload;
                try {
                    header = decode(parts[0]);
                    payload = decode(parts[1]);
                } catch (e) {
                    resultDiv.innerHTML = `
                        <div class="status status-error">
                            âŒ Token è§£ç å¤±è´¥<br>
                            ${e.message}
                        </div>
                    `;
                    solutionsDiv.innerHTML = `
                        <div class="status status-warning">
                            <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                            1. ç‚¹å‡»"æ¸…é™¤ Token"æŒ‰é’®<br>
                            2. ç‚¹å‡»"å‰å¾€ç™»å½•"é‡æ–°ç™»å½•
                        </div>
                    `;
                    return;
                }

                // 4. æ£€æŸ¥è¿‡æœŸæ—¶é—´
                const now = Math.floor(Date.now() / 1000);
                const exp = payload.exp;
                const isExpired = exp < now;
                const remainingSeconds = exp - now;
                const remainingMinutes = Math.floor(remainingSeconds / 60);

                // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
                if (isExpired) {
                    resultDiv.innerHTML = `
                        <div class="status status-error">
                            âŒ Token å·²è¿‡æœŸ<br>
                            è¿‡æœŸæ—¶é—´: ${new Date(exp * 1000).toLocaleString()}<br>
                            å·²è¿‡æœŸ: ${Math.abs(remainingMinutes)} åˆ†é’Ÿ
                        </div>
                    `;
                    solutionsDiv.innerHTML = `
                        <div class="status status-warning">
                            <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                            1. ç‚¹å‡»"æ¸…é™¤ Token"æŒ‰é’®<br>
                            2. ç‚¹å‡»"å‰å¾€ç™»å½•"é‡æ–°ç™»å½•<br>
                            3. ç™»å½•åä¼šè·å¾—æ–°çš„ Tokenï¼ˆæœ‰æ•ˆæœŸ 24 å°æ—¶ï¼‰
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status status-success">
                            âœ… Token æœ‰æ•ˆ<br>
                            è¿‡æœŸæ—¶é—´: ${new Date(exp * 1000).toLocaleString()}<br>
                            å‰©ä½™æ—¶é—´: ${remainingMinutes} åˆ†é’Ÿ
                        </div>
                    `;
                    solutionsDiv.innerHTML = `
                        <div class="status status-info">
                            <strong>Token çŠ¶æ€æ­£å¸¸</strong><br>
                            å¦‚æœä»ç„¶é‡åˆ° 401 é”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼š<br>
                            1. æµè§ˆå™¨ DevTools â†’ Network æ ‡ç­¾<br>
                            2. æŸ¥çœ‹è¯·æ±‚æ˜¯å¦æºå¸¦ Authorization header<br>
                            3. æ£€æŸ¥åç«¯æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
                        </div>
                    `;
                }

                // æ˜¾ç¤º Token è¯¦æƒ…
                detailsDiv.innerHTML = `
                    <div class="status status-info">
                        <strong>Header:</strong>
                        <pre>${JSON.stringify(header, null, 2)}</pre>
                    </div>
                    <div class="status status-info">
                        <strong>Payload:</strong>
                        <pre>${JSON.stringify(payload, null, 2)}</pre>
                    </div>
                    <div class="status status-info">
                        <strong>Token é¢„è§ˆ:</strong>
                        <div class="token-preview">${token}</div>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status status-error">
                        âŒ è¯Šæ–­å¤±è´¥<br>
                        ${error.message}
                    </div>
                `;
                console.error('è¯Šæ–­é”™è¯¯:', error);
            }
        }

        // æ¸…é™¤ Token
        function clearToken() {
            try {
                localStorage.removeItem('ACCESS_TOKEN');
                localStorage.removeItem('token');
                localStorage.removeItem('userInfo');

                document.getElementById('diagnosisResult').innerHTML = `
                    <div class="status status-success">
                        âœ… Token å·²æ¸…é™¤<br>
                        localStorage ä¸­çš„æ‰€æœ‰è®¤è¯ä¿¡æ¯å·²åˆ é™¤
                    </div>
                `;
                document.getElementById('tokenDetails').innerHTML = '';
                document.getElementById('solutions').innerHTML = `
                    <div class="status status-info">
                        <strong>ä¸‹ä¸€æ­¥ï¼š</strong><br>
                        ç‚¹å‡»"å‰å¾€ç™»å½•"æŒ‰é’®é‡æ–°ç™»å½•
                    </div>
                `;
            } catch (error) {
                alert('æ¸…é™¤å¤±è´¥: ' + error.message);
            }
        }

        // å‰å¾€ç™»å½•é¡µ
        function goToLogin() {
            window.location.href = 'http://localhost:3101/login';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯Šæ–­
        window.onload = function() {
            diagnose();
        };
    </script>
</body>
</html>
