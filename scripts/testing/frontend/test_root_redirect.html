<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¹è·¯å¾„è·³è½¬æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .status {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .icon {
            font-size: 20px;
            font-weight: bold;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.danger:hover {
            background: #c82333;
        }

        .code {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin-top: 10px;
        }

        .test-result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .test-result h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .test-result ul {
            list-style: none;
            padding-left: 0;
        }

        .test-result li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .test-result li:last-child {
            border-bottom: none;
        }

        .test-result li strong {
            color: #667eea;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ æ ¹è·¯å¾„è·³è½¬æµ‹è¯•å·¥å…·</h1>
        <p class="subtitle">æµ‹è¯•è®¿é—® http://localhost:3101/ æ—¶çš„è·¯ç”±è·³è½¬è¡Œä¸º</p>

        <!-- Token çŠ¶æ€æ£€æŸ¥ -->
        <div class="section">
            <h2>ğŸ“‹ å½“å‰çŠ¶æ€</h2>
            <div id="tokenStatus"></div>
            <div id="currentUrl" class="status info">
                <span class="icon">ğŸŒ</span>
                <span>å½“å‰ URL: <strong id="urlText"></strong></span>
            </div>
        </div>

        <!-- æµ‹è¯•åœºæ™¯ -->
        <div class="section">
            <h2>ğŸ§ª æµ‹è¯•åœºæ™¯</h2>
            <div class="test-result">
                <h3>åœºæ™¯ 1ï¼šæœªç™»å½•ç”¨æˆ·è®¿é—®æ ¹è·¯å¾„</h3>
                <ul>
                    <li><strong>æ“ä½œ:</strong> æ¸…é™¤ Token â†’ è®¿é—® http://localhost:3101/</li>
                    <li><strong>é¢„æœŸ:</strong> è‡ªåŠ¨è·³è½¬åˆ° /login</li>
                    <li><strong>éªŒè¯:</strong> æµè§ˆå™¨åœ°å€æ æ˜¾ç¤º http://localhost:3101/login</li>
                </ul>
                <button class="btn" onclick="testScenario1()">æ‰§è¡Œæµ‹è¯• 1</button>
            </div>

            <div class="test-result" style="margin-top: 15px;">
                <h3>åœºæ™¯ 2ï¼šå·²ç™»å½•ç”¨æˆ·è®¿é—®æ ¹è·¯å¾„</h3>
                <ul>
                    <li><strong>æ“ä½œ:</strong> ç™»å½•è·å– Token â†’ è®¿é—® http://localhost:3101/</li>
                    <li><strong>é¢„æœŸ:</strong> è‡ªåŠ¨è·³è½¬åˆ° /dashboard</li>
                    <li><strong>éªŒè¯:</strong> æµè§ˆå™¨åœ°å€æ æ˜¾ç¤º http://localhost:3101/dashboard</li>
                </ul>
                <button class="btn" onclick="testScenario2()">æ‰§è¡Œæµ‹è¯• 2</button>
            </div>

            <div class="test-result" style="margin-top: 15px;">
                <h3>åœºæ™¯ 3ï¼šå·²ç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•é¡µ</h3>
                <ul>
                    <li><strong>æ“ä½œ:</strong> ç™»å½•è·å– Token â†’ è®¿é—® http://localhost:3101/login</li>
                    <li><strong>é¢„æœŸ:</strong> è‡ªåŠ¨è·³è½¬åˆ° /dashboard</li>
                    <li><strong>éªŒè¯:</strong> æµè§ˆå™¨åœ°å€æ æ˜¾ç¤º http://localhost:3101/dashboard</li>
                </ul>
                <button class="btn" onclick="testScenario3()">æ‰§è¡Œæµ‹è¯• 3</button>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="section">
            <h2>ğŸ› ï¸ å¿«é€Ÿæ“ä½œ</h2>
            <button class="btn secondary" onclick="checkToken()">æ£€æŸ¥ Token</button>
            <button class="btn danger" onclick="clearToken()">æ¸…é™¤ Token</button>
            <button class="btn" onclick="goToRoot()">è®¿é—®æ ¹è·¯å¾„ /</button>
            <button class="btn" onclick="goToLogin()">è®¿é—®ç™»å½•é¡µ /login</button>
            <button class="btn" onclick="goToDashboard()">è®¿é—® Dashboard /dashboard</button>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="section">
            <h2>ğŸ” è°ƒè¯•ä¿¡æ¯</h2>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥ Token çŠ¶æ€
        function checkToken() {
            const tokenItem = localStorage.getItem('ACCESS_TOKEN');
            const tokenStatusDiv = document.getElementById('tokenStatus');
            const debugInfoDiv = document.getElementById('debugInfo');

            if (!tokenItem) {
                tokenStatusDiv.innerHTML = `
                    <div class="status error">
                        <span class="icon">âŒ</span>
                        <span>æœªæ‰¾åˆ° Tokenï¼ˆæœªç™»å½•çŠ¶æ€ï¼‰</span>
                    </div>
                `;
                debugInfoDiv.innerHTML = `
                    <div class="status warning">
                        <span class="icon">âš ï¸</span>
                        <span>localStorage ä¸­æ²¡æœ‰ ACCESS_TOKEN</span>
                    </div>
                `;
                return false;
            }

            try {
                const tokenData = JSON.parse(tokenItem);
                const token = tokenData.value;
                const parts = token.split('.');

                if (parts.length !== 3) {
                    throw new Error('Token æ ¼å¼é”™è¯¯');
                }

                const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                const exp = new Date(payload.exp * 1000);
                const now = new Date();
                const isExpired = exp < now;

                tokenStatusDiv.innerHTML = `
                    <div class="status ${isExpired ? 'error' : 'success'}">
                        <span class="icon">${isExpired ? 'âŒ' : 'âœ…'}</span>
                        <span>Token ${isExpired ? 'å·²è¿‡æœŸ' : 'æœ‰æ•ˆ'}</span>
                    </div>
                `;

                debugInfoDiv.innerHTML = `
                    <div class="code">
Token ä¿¡æ¯:
- ç”¨æˆ·: ${payload.user_metadata?.username || payload.email || 'æœªçŸ¥'}
- è¿‡æœŸæ—¶é—´: ${exp.toLocaleString('zh-CN')}
- å‰©ä½™æ—¶é—´: ${isExpired ? 'å·²è¿‡æœŸ' : Math.floor((exp - now) / 1000 / 60) + ' åˆ†é’Ÿ'}
- Token é•¿åº¦: ${token.length}
                    </div>
                `;

                return !isExpired;
            } catch (error) {
                tokenStatusDiv.innerHTML = `
                    <div class="status error">
                        <span class="icon">âŒ</span>
                        <span>Token è§£æå¤±è´¥: ${error.message}</span>
                    </div>
                `;
                debugInfoDiv.innerHTML = `
                    <div class="status error">
                        <span class="icon">âŒ</span>
                        <span>é”™è¯¯: ${error.message}</span>
                    </div>
                `;
                return false;
            }
        }

        // æ¸…é™¤ Token
        function clearToken() {
            localStorage.removeItem('ACCESS_TOKEN');
            localStorage.removeItem('token');
            localStorage.removeItem('userInfo');
            alert('âœ… Token å·²æ¸…é™¤');
            checkToken();
        }

        // è®¿é—®æ ¹è·¯å¾„
        function goToRoot() {
            window.location.href = '/';
        }

        // è®¿é—®ç™»å½•é¡µ
        function goToLogin() {
            window.location.href = '/login';
        }

        // è®¿é—® Dashboard
        function goToDashboard() {
            window.location.href = '/dashboard';
        }

        // æµ‹è¯•åœºæ™¯ 1ï¼šæœªç™»å½•ç”¨æˆ·è®¿é—®æ ¹è·¯å¾„
        function testScenario1() {
            if (confirm('å°†æ¸…é™¤ Token å¹¶è·³è½¬åˆ°æ ¹è·¯å¾„ /ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ')) {
                clearToken();
                setTimeout(() => {
                    window.location.href = '/';
                }, 500);
            }
        }

        // æµ‹è¯•åœºæ™¯ 2ï¼šå·²ç™»å½•ç”¨æˆ·è®¿é—®æ ¹è·¯å¾„
        function testScenario2() {
            const hasToken = checkToken();
            if (!hasToken) {
                alert('âŒ è¯·å…ˆç™»å½•è·å– Token\n\næ“ä½œæ­¥éª¤ï¼š\n1. ç‚¹å‡»"è®¿é—®ç™»å½•é¡µ /login"\n2. ä½¿ç”¨ admin/123456 ç™»å½•\n3. å†æ¬¡æ‰§è¡Œæ­¤æµ‹è¯•');
                return;
            }
            if (confirm('å°†è·³è½¬åˆ°æ ¹è·¯å¾„ /ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ')) {
                window.location.href = '/';
            }
        }

        // æµ‹è¯•åœºæ™¯ 3ï¼šå·²ç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•é¡µ
        function testScenario3() {
            const hasToken = checkToken();
            if (!hasToken) {
                alert('âŒ è¯·å…ˆç™»å½•è·å– Token\n\næ“ä½œæ­¥éª¤ï¼š\n1. ç‚¹å‡»"è®¿é—®ç™»å½•é¡µ /login"\n2. ä½¿ç”¨ admin/123456 ç™»å½•\n3. å†æ¬¡æ‰§è¡Œæ­¤æµ‹è¯•');
                return;
            }
            if (confirm('å°†è·³è½¬åˆ°ç™»å½•é¡µ /loginï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ')) {
                window.location.href = '/login';
            }
        }

        // æ›´æ–°å½“å‰ URL
        function updateCurrentUrl() {
            document.getElementById('urlText').textContent = window.location.href;
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.onload = function() {
            checkToken();
            updateCurrentUrl();
        };
    </script>
</body>
</html>
